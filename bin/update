#!/usr/bin/env bash -e
export STABLE_RUBIES="1.8.6 1.8.7 1.9.1 1.9.2 ree rbx jruby maglev ironruby macruby"
export EDGE_RUBIES="rbx-head ruby-1.8-head jruby-head ruby-head ruby-1.9.2-head"
export RUBIES="$STABLE_RUBIES $EDGE_RUBIES"
export IMPORTANT_GEMS="bundler backports rspec fuubar minitest gem-open"

function cmd() {
  echo -e "\n\033[0;33m>>>>>>>>>>>> $(date +%H:%m) \033[1;33m$@\033[m" >&2
  ($@ && echo -e "\n\033[0;32mSUCCESS\033[m") || echo -e "\n\033[0;31mFAIL\033[m"
}

function install_missing_gem() {
  (gem list $@ | grep -q $@ && echo "not missing") || cmd gem install $@
}

function update_redcar() {
  rvm use ree
  cd ~/Workspace/redcar
  git submodule init
  git submodule update
}

function update_gems() {
  for ruby in $RUBIES; do
    cmd rvm use $ruby
    #cmd gem update --system
    cmd gem update
    for gem in $IMPORTANT_GEMS; do
      cmd install_missing_gem $gem
    done
  done
}

cmd . $HOME/.rvm/scripts/rvm
cmd export ARCHFLAGS="-arch x86_64"

function update_rubies() {
  cmd rvm get head
  cmd rvm reload
  for ruby in $STABLE_RUBIES; do
    cmd rvm use $ruby --install
  done
  for ruby in $EDGE_RUBIES; do
    rvm use 1.9.2
    cmd rvm install $ruby
  done  
  update_gems
}

function update() {
  update_rubies
}

if [ $1 ]; then
  update_$@
else
  update
fi
